@using BudgetApp.Extensions
@using BudgetApp.Models
@model TransactionsViewModel

@{
    ViewBag.Title = "Transactions";
}



<div style="margin-top: 30px;" ng-controller="transactionController">


    <div fade-in="200">
        @using (Html.BeginForm("Index", "Transactions", FormMethod.Post))
        {
            <div class="row" style="margin-bottom: 20px;">
                <div class="col-xs-12 text-center">
                    <span class="text-muted">Showing @Model.TransactionsDisplayed / @Model.TotalTransactions transactions</span>
                </div>
            </div>
            
            <div class="row">
                <div class="col-xs-12 col-md-3">
                    <a href="@Url.Action("Create")" class="btn btn-default" title="Add transaction">
                        <i class="glyphicon glyphicon-plus-sign"></i>
                    </a>
                    <a href="@Url.Action("Upload")" class="btn btn-default" title="Import transactions">
                        <i class="glyphicon glyphicon-import"></i>
                    </a>

                </div>

                <div class="col-xs-12 col-md-9 text-right">

                    @Html.TextBoxFor(s => s.Filter.StartDate, new { @class = "transaction-filter", @required = "required", @type = "date", @ng_model = "startDate", @max = "{{endDate | date:'yyyy-MM-dd'}}" })
                     - 
                    @Html.TextBoxFor(s => s.Filter.EndDate, new { @type = "date", @class = "transaction-filter", @required = "required", @min = "{{startDate | date:'yyyy-MM-dd'}}", max = DateTime.Now.ToString("yyyy-MM-dd"), @ng_model = "endDate" })
                                   

                    @Html.EnumDropDownListFor(s => s.Filter.Range, new { @class = "transaction-filter" })

                    <button class="btn btn-primary" title="Filter">
                        <i class="glyphicon glyphicon-filter"></i>
                    </button>
                </div>

            </div>
        }


        @if (!Model.RangeViewers.Any())
        {

            <div class="jumbotron" fade-in="100" style="margin-top:30px;">

                <div id="icon" style="width: 30%;">
                    <object>
                        <img src="~/Content/images/logo_pig.svg" id="svg" />
                    </object>
                </div>

                <h3 class="text-center" style="margin-top: -40px;">No transactions registered between @Model.Filter.StartDate.ToShortDateString() and @Model.Filter.EndDate.ToShortDateString()</h3>



            </div>


        }
        else
        {

            <div class="row" style="margin-top: 30px;">
                <div class="col-xs-12" ng-repeat="range in model">


                    <div class="panel {{(range.totalIncome - range.totalExpenses) > 0 ? 'panel-success':'panel-danger'}}">

                        <div class="panel-body">

                            <div class="row">
                                
                                <div class="col-xs-4">
                                    <span class="label label-big label-muted" ng-show="range.year != range.title">
                                        {{range.year }}
                                    </span>
                                    
                                    <span class="label label-big label-muted" ng-show="filter.range === 2">
                                        {{range.startDate | monthName2 }}
                                    </span>

                                    <span class="label label-primary label-big">
                                        {{range.title @(Model.RangeViewers[0].Range == Range.Month ? "| monthName" : "") }}
                                    </span>

                                </div>
                                <div class="col-xs-4 text-center">
                                    <span class="text-muted">
                                        {{range.startDate | date : 'dd.MM.yyyy'}} - {{range.endDate | date: 'dd.MM.yyyy'}}
                                    </span>
                                                                        
                                </div>

                                <div class="col-xs-4 text-right">                                                                       
                                    
                                    <span value="false" ng-model="showBalance.$index" ng-click="showBalance.$index = !showBalance.$index" style="min-height: 34px;" class="toggle-transactions {{showBalance.$index ? 'active':''}}"> Balance</span>

                                    <span class="toggle-transactions {{range.$index ? 'active':''}}" ng-click="range.$index = !range.$index">
                                        <i class="glyphicon glyphicon-zoom-in" ng-hide="range.$index"></i>
                                        <i class="glyphicon glyphicon-zoom-out" ng-show="range.$index"></i>
                                        {{range.transactions.length}}
                                    </span>
                                </div>

                            </div>

                            <div class="row">
                                <div class="col-xs-12 placeholder hidden-xs" ng-hide="showBalance.$index">

                                    <span style="height:350px;width:1123px !important;" class="visible-lg" data-highchart="{{range.graph}}"></span>

                                    <span style="height:350px;width:923px !important;" class="visible-md" data-highchart="{{range.graph}}"></span>

                                    <span style="height:350px;width:703px !important;" class="visible-sm" data-highchart="{{range.graph}}"></span>

                                </div>
                                
                                <div class="col-xs-12 placeholder hidden-xs" ng-show="showBalance.$index">

                                    <span style="height:350px;width:1123px !important;" class="visible-lg" data-gauge data-income="{{range.totalIncome}}" data-expense="{{range.totalExpenses}}"></span>

                                    <span style="height:350px;width:923px !important;" class="visible-md" data-gauge data-income="{{range.totalIncome}}" data-expense="{{range.totalExpenses}}"></span>

                                    <span style="height:350px;width:703px !important;" class="visible-sm" data-gauge data-income="{{range.totalIncome}}" data-expense="{{range.totalExpenses}}"></span>

                                </div>
                            </div>

                        </div>
                        <table class="table table-condensed table-same-width" ng-show="range.$index">
                            <thead>
                                <tr>
                                    <th class="hidden-xs">#</th>
                                    <th>Amount</th>
                                    <th>Category</th>
                                    <th>Date</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="row in range.transactions">
                                    <td class="hidden-xs">{{$index + 1}}</td>
                                    <td>{{row.amount}}</td>
                                    <td>{{row.category | camelCaseToNormal}}</td>
                                    <td>{{row.date | date}}</td>
                                    <td class="text-right">
                                        <a class="link details-link" href="{{urls.details}}/{{row.transactionId}}" title="Details"><i class="glyphicon glyphicon-zoom-in"></i></a>
                                        <a class="link edit-link" href="{{urls.edit}}/{{row.transactionId}}" title="Edit"><i class="glyphicon glyphicon-pencil"></i></a>
                                        <a class="link delete-link" href="{{urls.del}}/{{row.transactionId}}" title="Delete">
                                            <i class="glyphicon glyphicon-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>


                </div>

            </div>

        }
    </div>

</div>

<script>

    (function() {
        'use strict';

        angular.module('budgetApp').factory('transactionModel', function() {

            return {
                filter : @Html.Raw(Model.Filter.ToJson()),
                model: @Html.Raw(Model.RangeViewers.ToJson()),
                urls: {
                    del: '@Url.Action("Delete")',
                    edit: '@Url.Action("Edit")',
                    details: '@Url.Action("Details")'
                }
            };

        });

    })();

</script>