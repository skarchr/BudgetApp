@using BudgetApp.Extensions
@model BudgetApp.Models.DashboardViewModel

@{
    ViewBag.Title = "Dashboard";
}

<script src="~/js/directives/GraphDirectives.js"></script>

<div class="row" ng-controller="dashboardController">

    <div class="row">
        <div class="col-xs-8">

            <span style="padding:0;padding-right:5px;width:140px;">
                <a data-set-date="All">All transactions</a>
                <span class="sep">|</span>
                <a set-date-year="year" ng-repeat="year in years">{{year}}</a>
                <a data-set-date="Month" class="active">Current month</a>
            </span>
        </div>
        <div class="col-xs-4 text-right">
            <span style="padding:0;width:140px;">
                <input ng-click="open($event)" type="text" name="FromDate" id="FromDate" ng-change="refreshBtn()" class="datepicker text-center" datepicker-popup="{{format}}" max-date="model.toDate" ng-model="model.fromDate" is-open="opened" datepicker-options="dateOptions" ng-required="true" close-text="Close" />
            </span>

            <span style="padding:0;width:140px;">
                <input ng-click="open2($event)" type="text" name="ToDate" id="ToDate" ng-change="refreshBtn()" class="datepicker text-center" datepicker-popup="{{format}}" ng-model="model.toDate" is-open="opened2" min-date="model.fromDate" max-date="today" datepicker-options="dateOptions" ng-required="true" close-text="Close" />
            </span>
            <button set-date-inactive id="refreshBtn" ng-disabled="disableRefresh" class="btn btn-primary btn-xs" ng-click="submit()"><i class="glyphicon glyphicon-refresh"></i></button>
        </div>

    </div>

    <div class="row" style="margin-top: 20px;" ng-hide="error">
        <div class="col-xs-12 text-center">
            <span style="font-size: 20px;" class="text-danger {{model.variables.balance > 0 ?'text-success':'text-danger'}}"><i class="glyphicon glyphicon-transfer"></i> {{model.variables.balance | currencyFormatter}}</span>
        </div>
    </div>

    <div class="row" style="margin-top:20px;" ng-hide="error">
        <div class="col-xs-12 col-md-6 col-lg-4 col-graph">
            <div ng-show="spinner" class="spinner">
                <div class="spinner">
                    <div class="ball"></div>
                    <p>LOADING</p>
                </div>
            </div>
            <div ng-hide="spinner" class="graph">
                <span data-highchart-reload ng-model="model.variables.transactionGraph"></span>
            </div>
        </div>

        <div class="col-xs-12 col-md-6 col-lg-8 col-graph">
            <div ng-show="spinner" class="spinner">
                <div class="spinner">
                    <div class="ball"></div>
                    <p>LOADING</p>
                </div>
            </div>
            <div ng-hide="spinner" class="graph">
                <span data-spc-reload ng-model="model.variables.balanceGraph" width="780"></span>
            </div>
        </div>        
        <div class="col-xs-12 col-md-6 col-lg-4 col-graph">
            <div ng-show="spinner" class="spinner">
                <div class="spinner">
                    <div class="ball"></div>
                    <p>LOADING</p>
                </div>
            </div>
            <div ng-hide="spinner" class="graph">
                <span data-treemap-reload ng-model="model.variables.treemapChart"></span>
            </div>
        </div>
        <div class="col-xs-12 col-md-6 col-lg-8 col-graph">
            <div ng-show="spinner" class="spinner">
                <div class="spinner">
                    <div class="ball"></div>
                    <p>LOADING</p>
                </div>
            </div>
            <div ng-hide="spinner" class="graph">
                <span data-spc-reload ng-model="model.variables.categoryGraph" width="780"></span>
            </div>
        </div>
        <div class="col-xs-12 col-md-6 col-lg-4 col-graph">
            <div ng-show="spinner" class="spinner">
                <div class="spinner">
                    <div class="ball"></div>
                    <p>LOADING</p>
                </div>
            </div>
            <div ng-hide="spinner" class="graph">
                <span data-frequency-reload ng-model="model.variables.frequency"></span>
            </div>
        </div>
    </div>
    
    <div class="row" style="margin-top:30px;">
        <div class="col-xs-4">
            <hr />
        </div>
        <div class="col-xs-4 text-center">
            <h3 style="margin-top:6px;">Additional info about current year</h3>
        </div>
        <div class="col-xs-4">
            <hr />
        </div>
    </div>


    <div class="row" style="margin-top: 30px;">
        
        <div class="col-xs-12 col-md-6 col-lg-4 col-graph">
            <div class="graph">
                <span data-burn-rate-reload ng-model="model.burnGraph"></span>
            </div>
        </div>
        
        <div class="col-xs-12 col-md-6 col-lg-8 col-graph">
            <div class="graph">
                <span data-spc-reload ng-model="model.spcGraph" width="780"></span>
            </div>
        </div>
        <div class="col-xs-12 col-md-6 col-lg-6 col-graph">
            <div class="graph">
                <span data-prog-highchart-reload ng-model="model.prognosisIncomeChart" width="580"></span>
            </div>
        </div>
        
        <div class="col-xs-12 col-md-6 col-lg-6 col-graph">
            <div class="graph">
                <span data-prog-highchart-reload ng-model="model.prognosisChart" width="580"></span>
            </div>
        </div>
        
    </div>
    <div class="row" style="margin-top: 20px;" ng-show="error">
        <div class="alert alert-danger text-center" style="font-size:18px;">
            <i class="glyphicon glyphicon-warning-sign"></i> Something went wrong! Try again!
        </div>
    </div>
</div>
<script>
    (function() {
        'use strict';

        angular.module('budgetApp').factory('dashboardService', ['$http',function($http) {

            var refresh = function(model) {
                return $http.get('@Url.Action("Refresh", "Dashboard")', { params: { from: model.fromDate, to: model.toDate } });
            };

            return {
                model:@Html.Raw(Model.ToJson()),
                refresh: refresh
            };

        }]);

        angular.module('budgetApp').controller('dashboardController', ['$scope','$timeout','dashboardService',function($scope,$timeout,dashboardService) {

            $scope.model = dashboardService.model;

            $scope.first = new Date(dashboardService.model.first);
            $scope.last = new Date(dashboardService.model.toDate);

            $scope.error = false;

            $scope.disableRefresh = true;

            $scope.refreshBtn = function() {
                $scope.disableRefresh = false;
            };

            $scope.years = [];

            for (var i = $scope.first.getFullYear(); i <= $scope.last.getFullYear(); i++) {
                $scope.years.push(i);
            }

            $scope.spinner = false;

            $scope.submit = function() {
                $scope.spinner = true;
                $scope.error = false;
                dashboardService.refresh($scope.model)
                    .success(function(data) {
                        $scope.model.variables = data;
                        $scope.spinner = false;
                    })
                    .error(function() {
                        $scope.error = true;
                    });
                $scope.disableRefresh = true;
            };

            //Datepicker

            $scope.today = new Date();

            $scope.opened = false;
            $scope.opened2 = false;

            $scope.open = function ($event) {
                $event.preventDefault();
                $event.stopPropagation();
                $scope.opened2 = false;
                $scope.opened = true;
            };

            $scope.open2 = function ($event) {
                $event.preventDefault();
                $event.stopPropagation();
                $scope.opened = false;
                $scope.opened2 = true;
            };

            $scope.dateOptions = {
                formatYear: 'yy',
                startingDay: 1
            };

            $scope.formats = ['yyyy-MM-dd', 'yyyy/MM/dd', 'dd.MM.yyyy', 'shortDate','MMMM d, y'];
            $scope.format = $scope.formats[4];

            $scope.disabled = function (date, mode) {
                return (mode === 'day' && (date.getDay() === 0 || date.getDay() === 6));
            };

        }]);

    })();
</script>