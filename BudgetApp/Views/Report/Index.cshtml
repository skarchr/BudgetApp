@using BudgetApp.Controllers
@using BudgetApp.Extensions
@using Microsoft.Ajax.Utilities
@model ReportController.ReportViewModel

@{
    ViewBag.Title = "Reports";
}

<div class="row" ng-controller="reportController">

    <div class="col-xs-12" style="border:2px solid #0094FF; -ms-border-radius: 40px; border-radius: 40px;">

        <ul class="list-unstyled list-inline" role="tablist" style="margin-top:-20px;">
            <li role="presentation" class="active">
                <a href="#chart" aria-controls="chart" role="tab" data-toggle="tab" class="btn btn-default btn-nav btn-sm btn-round text-center {{selected === 'charts' ? 'active':''}}" style="min-width: 40px;" ng-click="selected = 'charts'">
                    <i class="glyphicon glyphicon-signal"></i>
                </a>
            </li>
            <li role="presentation" style="margin-left: -10px;">
                <a href="#table" aria-controls="table" role="tab" data-toggle="tab" class="btn btn-default btn-nav btn-sm btn-round text-center {{selected === 'tables' ? 'active':''}}" style="min-width: 40px;" ng-click="selected = 'tables'">
                    <i class="glyphicon glyphicon-th"></i>
                </a>
            </li>
            <li role="presentation" style="margin-left: -10px;">
                <a href="#search" aria-controls="table" role="tab" data-toggle="tab" class="btn btn-default btn-nav btn-sm btn-round text-center {{selected === 'search' ? 'active':''}}" style="min-width: 40px;" ng-click="selected = 'search'">
                    <i class="glyphicon glyphicon-search"></i>
                </a>
            </li>
        </ul>

        @using (Html.BeginForm("DownloadExcelFile", "Report", FormMethod.Post, new { @class = "form-horizontal", @name = "chartForm" }))
        {

            <div class="form-group">
                <label class="col-sm-2 control-label">From</label>
                <div class="col-sm-10">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="input-group">
                                <input type="text" name="FromDate" id="FromDate" class="form-control" datepicker-popup="{{format}}" max-date="chartModel.toDate" ng-model="chartModel.fromDate" is-open="opened" datepicker-options="dateOptions" ng-required="true" close-text="Close" />
                                <span class="input-group-btn" style="width:0;padding:0px !important;">
                                    <button type="button" class="btn btn-default" ng-click="open($event)" style="padding-bottom: 7px;"><i class="glyphicon glyphicon-calendar"></i></button>
                                </span>
                            </p>
                        </div>
                    </div>                    
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">To</label>
                <div class="col-sm-10">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="input-group">
                                <input type="text" name="ToDate" id="ToDate" class="form-control" datepicker-popup="{{format}}" ng-model="chartModel.toDate" is-open="opened2" min-date="chartModel.fromDate" max-date="today" datepicker-options="dateOptions" ng-required="true" close-text="Close" />
                                <span class="input-group-btn" style="width:0;padding:0px !important;">
                                    <button type="button" class="btn btn-default" ng-click="open2($event)" style="padding-bottom: 7px;"><i class="glyphicon glyphicon-calendar"></i></button>
                                </span>
                            </p>
                        </div>
                    </div>                    
                </div>
            </div>

            <div class="form-group" ng-show="selected !== 'tables' && selected !== 'search'">
                <label class="col-sm-2 control-label">Choose chart</label>
                <div class="col-sm-10">
                    <ul class="list-unstyled">
                        @foreach (var chart in Model.Charts)
                        {
                            <li>
                                <div class="radio">
                                    <label>
                                        <input type="radio" name="Name" id="Name" ng-model="chartModel.name" value="@chart" />
                                        @chart.Replace('_', ' ')
                                    </label>
                                </div>
                            </li>
                        }
                    </ul>

                </div>
            </div>          

            <div class="form-group">
                <label class="col-sm-2 control-label">Categories</label>
                <div class="col-sm-10 form-inline">
                    <ul class="list-unstyled list-inline">
                        
                        @Html.DropDownListFor(s => s.Categories, new SelectList(Model.Categories.Select(x => new { Value = x, Text = CategoryExt.CamelCaseToNormal(x) }), "Value", "Text"), new { @multiple="multiple", @ng_model="chartModel.categories", @class="form-control", @style="height:200px;" })

                    </ul>

                </div>
            </div>

            <div class="form-group" ng-show="selected === 'search'">
                <label class="col-sm-2 control-label">Description text</label>
                <div class="col-sm-10 form-inline">                    
                    @Html.TextBoxFor(m => m.SearchString, new { @class="form-control", @ng_model="chartModel.searchString" })
                </div>
            </div>

            <div class="form-group" ng-show="selected === 'tables'">
                <label class="col-sm-2 control-label">Sheets by</label>
                <div class="col-sm-10 form-inline">
                    <div class="radio">
                        <label>
                            <input type="radio" name="ByYear" id="ByYear" ng-model="chartModel.byYear" value="true" checked="checked" />
                            Year
                        </label>
                    </div>
                    <div class="radio">
                        <label>
                            <input type="radio" name="ByYear" id="ByYear" ng-model="chartModel.byYear" value="false" />
                            Category
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="form-group" ng-show="(chartModel.name === '@ReportController.SPC' || chartModel.name === '@ReportController.BoxPlot') && selected === 'charts'">
                <label class="col-sm-2 control-label">Range</label>
                <div class="col-sm-10 form-inline">
                    <select name="Range" ng-model="chartModel.range" class="form-control">
                        <option value="0">Daily</option>
                        <option value="1">Weekly</option>
                        <option value="2">Monthly</option>
                    </select>
                </div>
            </div>

            <div class="form-group" ng-show="chartModel.name === '@ReportController.Drilldown' && selected === 'charts'">
                <label class="col-sm-2 control-label">Chart type</label>
                <div class="col-sm-10 form-inline">
                    <select name="ChartType" ng-model="chartModel.chartType" class="form-control">
                        <option value="column">Column</option>
                        <option value="pie">Pie</option>
                    </select>
                </div>
            </div>

            <div class="form-group" ng-show="selected === 'charts'">
                <div class="col-sm-offset-2 col-sm-10 form-inline">
                    <button ng-disabled="chartForm.$invalid || chartModel.categories.length === 0" class="btn btn-primary" data-get-chart-view>Generate chart</button>
                </div>
            </div>
            
            <div class="form-group" ng-show="selected === 'tables'">
                <div class="col-sm-offset-2 col-sm-10 form-inline">
                    <button ng-disabled="chartModel.categories.length === 0" class="btn btn-primary" type="submit">
                        Download Excel file
                    </button>
                </div>
            </div>

            
        }

        <!-- Tab panes -->
        <div class="tab-content" style="margin-bottom: 40px;">
            <div role="tabpanel" class="tab-pane active" id="chart">
                <div id="chartView"></div>
            </div>
            <div role="tabpanel" class="tab-pane" id="table">

            </div>
            <div role="tabpanel" class="tab-pane" id="search">
                
               
                <div class="row">
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button ng-disabled="chartModel.categories.length === 0" class="btn btn-primary" ng-click="search()">
                                Search
                            </button>
                        </div>
                    </div>
                </div>
                
                
                <div ng-show="searching" style="min-height: 200px;">
                    
                    Searching...

                </div>
                
                <div ng-show="searchResult.length > 0" style="margin-top: 30px;">
                    
                    Found {{searchStorage.length}} transactions that matches the query

                    <table class="table table-condensed table-striped">

                        <thead>
                            <tr>
                                <th class="text-center">#</th>
                                <th class="text-center">Amount</th>
                                <th class="text-center">Category</th>
                                <th>Description</th>
                                <th class="text-center">Date</th>
                                <th class="text-center">Created</th>
                                <th class="text-right"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="trans in searchResult">
                                <td class="text-center">{{$index + 1}}</td>
                                <td class="text-center">{{trans.amount | currencyFormatter}}</td>
                                <td class="text-center">{{trans.categoryText}}</td>
                                <td>{{trans.description}}</td>
                                <td class="text-center">{{trans.date | date}}</td>
                                <td class="text-center">{{trans.created | date}}</td>
                                <td class="text-right">
                                    <a class="link edit-link" href="{{urls.edit}}/{{trans.transactionId}}" title="Edit"><i class="glyphicon glyphicon-pencil"></i></a>
                                    <a class="link delete-link" href="{{urls.del}}/{{trans.transactionId}}" title="Delete">
                                        <i class="glyphicon glyphicon-trash"></i>
                                    </a>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <button class="btn btn-primary" style="width:100%;" ng-show="searchStorage.length > searchResult.length" ng-click="loadMore()">Load more</button>

                </div>

                

            </div>
        </div>


    </div>

</div>
<script src="~/bower_components/highstock-release/modules/exporting.js"></script>
<script src="~/js/directives/ReportDirectives.js"></script>
<script>
    (function() {
        'use strict';

        angular.module('budgetApp').factory('reportFactory', function() {
            return {
                model:@Html.Raw(Model.ToJson()),
                urls: {
                    del: '@Url.Action("Delete", "Transactions")',
                    edit: '@Url.Action("Edit", "Transactions")'
                }
                };
        });

    })();
</script>